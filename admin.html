<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>Admin - Add Product</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial; padding: 20px; direction: rtl; text-align: right; }
    input, textarea { width: 280px; padding: 8px; }
    button { padding: 10px 18px; cursor: pointer; }
  </style>
</head>

<body>

  <h1>لوحة الأدمن - إضافة منتج</h1>

  <div id="authStatus" style="margin-bottom:15px;color:red;font-weight:bold;"></div>

  <form id="productForm" style="display:none">
    <input id="pname" placeholder="اسم المنتج" required><br><br>
    <textarea id="pdesc" placeholder="الوصف"></textarea><br><br>
    <input id="pprice" placeholder="السعر" type="number" required><br><br>
    <input id="pimage" type="file" accept="image/*" required><br><br>
    <button type="submit">أضف المنتج</button>
  </form>

  <br>
  <a href="index.html">العودة للموقع</a>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAAYSyJf1YPFU7bXB87hKuPSUzJ53G0tt4",
      authDomain: "maher-phone-18581.firebaseapp.com",
      projectId: "maher-phone-18581",
      storageBucket: "maher-phone-18581.appspot.com",
      messagingSenderId: "452858222210",
      appId: "1:452858222210:web:12fa439652c4aa0b48869b",
      measurementId: "G-STSKLY357L"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const ADMIN_EMAIL = "clever2251999@gmail.com";

    const authStatus = document.getElementById("authStatus");
    const productForm = document.getElementById("productForm");

    // مراقبة حالة تسجيل الدخول
    auth.onAuthStateChanged((user) => {
      if (!user) {
        authStatus.textContent = "يجب تسجيل الدخول أولاً من الصفحة الرئيسية.";
        return;
      }

      authStatus.style.color = "green";
      authStatus.textContent = "مسجّل دخول: " + user.email;

      if (user.email === ADMIN_EMAIL) {
        productForm.style.display = "block";
      } else {
        authStatus.style.color = "red";
        authStatus.textContent += " — ليس لديك صلاحية الأدمن.";
      }
    });

    // إضافة منتج
    productForm.onsubmit = async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user || user.email !== ADMIN_EMAIL) {
        alert("ليس لديك صلاحية");
        return;
      }

      const name = document.getElementById("pname").value;
      const desc = document.getElementById("pdesc").value;
      const price = parseFloat(document.getElementById("pprice").value);
      const file = document.getElementById("pimage").files[0];

      if (!file) {
        alert("اختر صورة للمنتج");
        return;
      }

      try {
        // رفع الصورة
        const storageRef = storage.ref("product_images/" + Date.now() + "_" + file.name);
        const snap = await storageRef.put(file);
        const imageURL = await snap.ref.getDownloadURL();

        // إضافة المنتج لقاعدة البيانات
        await db.collection("products").add({
          name,
          description: desc,
          price,
          imageURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("تمت إضافة المنتج بنجاح");
        productForm.reset();

      } catch (err) {
        alert("خطأ: " + err.message);
      }
    };
  </script>
</body>
</html>
