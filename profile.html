<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>صفحتي</title>
</head>

<body>
  <h1>صفحتي الشخصية</h1>
  <div id="authInfo"></div>

  <h3>تعبئة بيانات الحساب</h3>
  <input id="name" placeholder="الاسم"><br>
  <input id="phone" placeholder="الهاتف"><br>
  <input id="address" placeholder="العنوان"><br>
  <button id="saveProfile">احفظ البيانات</button>

  <h3>سلة المشتريات</h3>
  <div id="cart"></div>

  <a href="index.html">العودة للمنتجات</a>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAAYSyJf1YPFU7bXB87hKuPSUzJ53G0tt4",
      authDomain: "maher-phone-18581.firebaseapp.com",
      projectId: "maher-phone-18581",
      storageBucket: "maher-phone-18581.appspot.com",
      messagingSenderId: "452858222210",
      appId: "1:452858222210:web:12fa439652c4aa0b48869b",
      measurementId: "G-STSKLY357L"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authInfo = document.getElementById("authInfo");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const addressEl = document.getElementById("address");
    const saveBtn = document.getElementById("saveProfile");
    const cartDiv = document.getElementById("cart");

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        authInfo.textContent = "رجاءً سجل الدخول في الصفحة الرئيسية.";
        return;
      }

      authInfo.textContent = "مرحبًا: " + user.email;

      const userRef = db.collection("users").doc(user.uid);
      const snap = await userRef.get();

      // لو المستخدم جديد → سيبه فاضي
      if (snap.exists) {
        const d = snap.data();
        nameEl.value = d.name || "";
        phoneEl.value = d.phone || "";
        addressEl.value = d.address || "";
      }

      // حفظ البيانات
      saveBtn.onclick = async () => {
        await userRef.set({
          name: nameEl.value,
          phone: phoneEl.value,
          address: addressEl.value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        alert("تم حفظ البيانات");
      };

      // عرض السلة
      db.collection("users")
        .doc(user.uid)
        .collection("cart")
        .onSnapshot((snap) => {
          cartDiv.innerHTML = "";
          let total = 0;

          snap.forEach((doc) => {
            const item = doc.data();
            total += item.price * item.qty;

            const row = document.createElement("div");
            row.innerHTML = `
              ${item.name} - ${item.qty} - ${item.price} جنيه
              <button onclick="inc('${doc.id}')">+</button>
              <button onclick="dec('${doc.id}')">-</button>
              <button onclick="removeItem('${doc.id}')">حذف</button>
            `;
            cartDiv.appendChild(row);
          });

          const totalEl = document.createElement("div");
          totalEl.innerHTML = `<strong>المجموع: ${total} جنيه</strong>`;
          cartDiv.appendChild(totalEl);
        });
    });

    // زيادات السلة
    window.inc = async (cartId) => {
      const uid = auth.currentUser.uid;
      await db.collection("users").doc(uid)
        .collection("cart").doc(cartId)
        .update({ qty: firebase.firestore.FieldValue.increment(1) });
    };

    window.dec = async (cartId) => {
      const uid = auth.currentUser.uid;
      const ref = db.collection("users").doc(uid)
        .collection("cart").doc(cartId);

      const doc = await ref.get();
      if (!doc.exists) return;

      if (doc.data().qty <= 1) ref.delete();
      else ref.update({ qty: firebase.firestore.FieldValue.increment(-1) });
    };

    window.removeItem = async (cartId) => {
      const uid = auth.currentUser.uid;
      await db.collection("users").doc(uid)
        .collection("cart").doc(cartId)
        .delete();
    };
  </script>

</body>
</html>
