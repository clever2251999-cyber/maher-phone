<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Add Product</title>
</head>

<body>
  <h1>لوحة الأدمن - أضف منتج</h1>
  <div id="authStatus"></div>

  <form id="productForm">
    <input id="pname" placeholder="اسم المنتج" required><br>
    <textarea id="pdesc" placeholder="الوصف"></textarea><br>
    <input id="pprice" placeholder="السعر" type="number" required><br>
    <input id="pimage" type="file" accept="image/*" required><br>
    <button type="submit">أضف المنتج</button>
  </form>

  <a href="index.html">العودة للموقع</a>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAAYSyJf1YPFU7bXB87hKuPSUzJ53G0tt4",
      authDomain: "maher-phone-18581.firebaseapp.com",
      projectId: "maher-phone-18581",
      storageBucket: "maher-phone-18581.appspot.com",
      messagingSenderId: "452858222210",
      appId: "1:452858222210:web:12fa439652c4aa0b48869b",
      measurementId: "G-STSKLY357L"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const ADMIN_EMAIL = "clever2251999@gmail.com";

    const authStatus = document.getElementById("authStatus");
    const productForm = document.getElementById("productForm");

    auth.onAuthStateChanged((user) => {
      if (!user) {
        authStatus.textContent = "سجّل الدخول من الصفحة الرئيسية أولاً.";
        productForm.style.display = "none";
        return;
      }

      authStatus.textContent = "أدخل بواسطة: " + user.email;

      if (user.email !== ADMIN_EMAIL) {
        authStatus.textContent += " — ليس لديك صلاحية الأدمن.";
        productForm.style.display = "none";
      }
    });

    productForm.onsubmit = async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user || user.email !== ADMIN_EMAIL) {
        alert("ليس لديك صلاحية");
        return;
      }

      const name = document.getElementById("pname").value;
      const desc = document.getElementById("pdesc").value;
      const price = parseFloat(document.getElementById("pprice").value);
      const file = document.getElementById("pimage").files[0];

      if (!file) {
        alert("اختر صورة");
        return;
      }

      // رفع الصورة
      const storageRef = storage.ref().child("product_images/" + Date.now() + "_" + file.name);
      const snap = await storageRef.put(file);
      const imageURL = await snap.ref.getDownloadURL();

      // إضافة المنتج
      await db.collection("products").add({
        name,
        description: desc,
        price,
        imageURL,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("تمت إضافة المنتج بنجاح");
      productForm.reset();
    };
  </script>

</body>
</html>
