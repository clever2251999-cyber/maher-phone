<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>سلة المشتريات</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
 body{font-family:Arial;padding:16px}
 input,textarea{width:100%;padding:8px;margin:6px 0}
 button{padding:8px 14px;margin-top:5px}
 .itemBox{border:1px solid #ddd;margin:6px 0;padding:10px;border-radius:6px}
</style>
</head>

<body>

<h2>سلة مشترياتك</h2>
<div id="cart"></div>

<h3>بيانات العميل</h3>
<input id="cname" placeholder="الاسم">
<input id="cphone" placeholder="رقم الهاتف">
<textarea id="caddress" placeholder="العنوان"></textarea>

<button id="sendOrder">إرسال الطلب</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<script>
const cartDiv = document.getElementById("cart");

auth.onAuthStateChanged(user=>{
  if(!user){
    cartDiv.innerHTML = "<p>سجل دخول أولاً.</p>";
    return;
  }

  db.collection("carts").doc(user.uid).collection("items")
    .onSnapshot(snap=>{
      cartDiv.innerHTML = "";
      let total = 0;

      snap.forEach(doc=>{
        const p = doc.data();
        total += p.price;

        cartDiv.innerHTML += `
          <div class="itemBox">
            <img src="${p.image}" width="80">
            <h3>${p.name}</h3>
            <p>السعر: ${p.price} جنيه</p>

            <button onclick="removeItem('${doc.id}')">❌ حذف</button>
          </div>
        `;
      });

      cartDiv.innerHTML += `<h3>الإجمالي: ${total} جنيه</h3>`;
    });
});

// حذف منتج من السلة
async function removeItem(id){
  const user = auth.currentUser;
  if(!user) return;

  await db.collection("carts")
    .doc(user.uid)
    .collection("items")
    .doc(id)
    .delete();

  alert("تم حذف المنتج من السلة");
}

// إرسال الطلب
document.getElementById("sendOrder").onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return alert("سجل دخول أولاً");

  const name = cname.value.trim();
  const phone = cphone.value.trim();
  const address = caddress.value.trim();

  if(!name || !phone || !address){
    alert("املأ جميع البيانات");
    return;
  }

  const itemsSnap = await db.collection("carts").doc(user.uid).collection("items").get();
  let items = [];
  let total = 0;

  itemsSnap.forEach(d=>{
    items.push(d.data());
    total += d.data().price;
  });

  if(items.length === 0){
    alert("السلة فارغة");
    return;
  }

  await db.collection("orders").add({
    user: user.uid,
    name, phone, address,
    items,
    total,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  // مسح السلة بعد إرسال الطلب
  await db.collection("carts").doc(user.uid).collection("items")
    .get().then(q=>q.forEach(d=>d.ref.delete()));

  alert("تم إرسال طلبك بنجاح");
  location.href = "products.html";
};
</script>

</body>
</html>
