<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>السلة - ماهر فون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-4">
  <h2>سلة المشتريات</h2>
  <div id="cartItems"></div>
  <hr>
  <button id="checkoutBtn" class="btn btn-success">اكمال الشراء</button>
  <a class="btn btn-secondary" href="products.html">العودة للمنتجات</a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<script>
auth.onAuthStateChanged(async user=>{
  if(!user) return window.location.href = "index.html";
  const uid = user.uid;
  const cartRef = db.collection('users').doc(uid).collection('cart');

  cartRef.onSnapshot(async snap=>{
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
    let total = 0;
    for(const doc of snap.docs){
      const it = doc.data();
      const prodDoc = await db.collection('products').doc(it.productId).get();
      const p = prodDoc.exists ? prodDoc.data() : null;
      if(!p) continue;
      total += (p.price * (it.qty || 1));
      container.innerHTML += `
        <div class="card p-2 mb-2">
          <h5>${p.name}</h5>
          <p>الكمية: ${it.qty || 1} — السعر: ${p.price} جنيه</p>
          <button class="btn btn-sm btn-outline-primary" onclick="inc('${doc.id}')">+</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="dec('${doc.id}')">-</button>
          <button class="btn btn-sm btn-danger" onclick="removeItem('${doc.id}')">حذف</button>
        </div>
      `;
    }
    container.innerHTML += `<div class="mt-3"><strong>المجموع: ${total} جنيه</strong></div>`;
  });
});

window.inc = async (cartId) => {
  const uid = auth.currentUser.uid;
  await db.collection('users').doc(uid).collection('cart').doc(cartId).update({ qty: firebase.firestore.FieldValue.increment(1) });
};
window.dec = async (cartId) => {
  const uid = auth.currentUser.uid;
  const ref = db.collection('users').doc(uid).collection('cart').doc(cartId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const qty = doc.data().qty || 1;
  if(qty <= 1) await ref.delete();
  else await ref.update({ qty: firebase.firestore.FieldValue.increment(-1) });
};
window.removeItem = async (cartId) => {
  const uid = auth.currentUser.uid;
  await db.collection('users').doc(uid).collection('cart').doc(cartId).delete();
};

document.getElementById('checkoutBtn').onclick = () => { window.location.href = 'checkout.html'; };
</script>
</body>
</html>
